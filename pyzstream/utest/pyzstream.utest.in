#!/usr/bin/env bash
#
# pyzstream test runner

projsrcdir=@PROJECT_SOURCE_DIR@
projbindir=@PROJECT_BINARY_DIR@
srcdir=@CMAKE_CURRENT_SOURCE_DIR@
bindir=@CMAKE_CURRENT_BINARY_DIR@

# build directory that contains pyzstream .so
pyzstream_libdir=${projbindir}/pyzstream
pyzstream_srcdir=${projsrcdir}/pyzstream

export PYTHONPATH=${pyzstream_libdir}:${pyzstream_srcdir}:${PYTHONPATH}

usage() {
    echo "$0 [-i | --interactive] [--path] [--shell] [--coverage] [-h | --help | --usage] -- ARGS" 1>&2
}

help() {
    usage

    cat <<EOF

with no arguments,  run python unit tests
  
Options:
  -u | --usage         brief help message
  --help               this help message
  -i | --interactive   exec python (interactively) with unittest PYTHONPATH
  --path               print PYTHONPATH to console
  --shell              exec bash (interactively) with unittest PYTHONPATH set
  --coverage           run unittest with coverage + report

EOF
}

usage_flag=0
help_flag=0
path_flag=0
shell_flag=0
interactive_flag=0
coverage_flag=0

while [[ $# > 0 ]]; do
    case "$1" in
        -i | --interactive)
            interactive_flag=1
            ;;
        --usage)
            usage_flag=1
            ;;
        -h | --help)
            help_flag=1
            ;;
        --path)
            path_flag=1
            ;;
        --shell)
            shell_flag=1
            ;;
        --coverage)
            coverage_flag=1
            ;;
        --)
            # forward remaining args to python session
            shift
            break
            ;;
        *)
            usage
            exit 1
            ;;
    esac

    shift
done

if [[ $usage_flag -eq 1 ]]; then
    # usage message only
    echo -n "usage: "
    usage
elif [[ $help_flag -eq 1 ]]; then
    # help message only
    echo -n "help: "
    help
elif [[ $interactive_flag -eq 1 ]]; then
    # interactive python session,  with PYTHONPATH referring to:
    # 1. c++ libraries in build tree
    # 2. python libraries in source tree
    #
    exec python $@
elif [[ $path_flag -eq 1 ]]; then
    echo "PYTHONPATH=${PYTHONPATH}"
elif [[ $shell_flag -eq 1 ]]; then
    # run bash.  environment has modified PYTHONPATH
    exec bash
elif [[ $coverage_flag -eq 1 ]]; then
    coverage run -m unittest utest
    coverage html

    echo

    coverage report -m
    
    echo
    echo "point browser to [file:///${bindir}/htmlcov/index.html] for html version"
else
    # python module is cmake-examples/pyzstream/utest,
    # which imports pyzstream_utest
    #
    python -m unittest utest $@
fi

